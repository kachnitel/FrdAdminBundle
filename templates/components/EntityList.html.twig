{#
 # LiveComponent template for reactive entity lists with per-column filters.
 #
 # Uses DataSourceInterface for all data sources. Doctrine entities use DoctrineDataSource
 # while custom data sources (e.g., audit logs) implement DataSourceInterface directly.
 #
 # Props:
 # @var string entityClass - Entity class name (for Doctrine entities)
 # @var string dataSourceId - Data source identifier (for custom data sources)
 # @var string search - Global search query
 # @var string sortBy - Sort field
 # @var string sortDirection - ASC or DESC
 # @var array columnFilters - Per-column filter values
 #}

{% set dataSource = this.dataSource %}
{% set isDoctrineEntity = this.isDoctrineEntity() %}
{% set showBatchColumn = this.canBatchDelete() %}

<div
    {% if showBatchColumn %}
        {{ attributes.defaults({ 'data-controller': 'batch-select' }) }}
    {% else %}
        {{ attributes }}
    {% endif %}
>
    {# Batch Actions Bar #}
    {% if showBatchColumn %}
        {% include '@KachnitelAdmin/components/EntityList/_BatchActionsBar.html.twig' with {
            selectedCount: this.selectedIds|length
        } only %}
    {% endif %}


    {# Global Search #}
    {% if block('search') is defined %}
        <div class="admin-global-search mb-3">
            {{ block('search') }}
        </div>
    {% else %}
        <div class="admin-global-search mb-3">
            <input
                type="text"
                class="form-control"
                placeholder="Global search across all columns..."
                data-model="search"
                value="{{ this.search }}"
            >
        </div>
    {% endif %}

    {# Entity List Table #}
    <table class="table table-hover">
        <thead>
            <tr>
                {% if showBatchColumn %}
                    <th style="width: 40px;">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            title="Select/Deselect All"
                            data-batch-select-target="master"
                            data-action="change->batch-select#toggleAll"
                        >
                    </th>
                {% endif %}
                {% for column in this.columns %}
                    {% include '@KachnitelAdmin/components/EntityList/_SortableHeader.html.twig' with {
                        column: column,
                        columnLabel: dataSource.columns[column] is defined ? dataSource.columns[column].label : null,
                        sortBy: sortBy,
                        sortDirection: sortDirection,
                        component: this
                    } only %}
                {% endfor %}
                <th>Actions</th>
            </tr>
            <tr class="filters">
                {% if showBatchColumn %}
                    <th></th>
                {% endif %}
                {% for column in this.columns %}
                    <th>
                        {% if this.filterMetadata[column] is defined %}
                            {#
                             Pass the initial value so it persists on re-renders.
                             #}
                            <twig:K:Admin:ColumnFilter
                                column="{{ column }}"
                                value="{{ this.columnFilters[column] ?? '' }}"
                                type="{{ this.filterMetadata[column].type|default('text') }}"
                            />
                        {% endif %}
                    </th>
                {% endfor %}
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for entity in this.entities %}
                {% set entityId = this.getEntityId(entity) %}
                <tr>
                    {% if showBatchColumn %}
                        <td>
                            <input
                                type="checkbox"
                                class="form-check-input"
                                value="{{ entityId }}"
                                {% if entityId in this.selectedIds %}checked{% endif %}
                                data-model="selectedIds[]"
                                data-batch-select-target="checkbox"
                                data-action="click->batch-select#toggle"
                            >
                        </td>
                    {% endif %}
                    {% for column in this.columns %}
                        <td>
                            {% set value = this.getEntityValue(entity, column) %}
                            {% if not isDoctrineEntity %}
                                {# Custom DataSource: use column metadata for type #}
                                {% set columnMeta = dataSource.columns[column] ?? null %}
                                {% set columnType = columnMeta ? columnMeta.type : 'string' %}
                                {% if columnMeta and columnMeta.template %}
                                    {# Custom template specified in column metadata #}
                                    {{ include(columnMeta.template, {
                                        entity: entity,
                                        item: entity,
                                        value: value,
                                        property: column,
                                        cell: true
                                    }) }}
                                {% else %}
                                    {% set templateName = columnType == 'collection' ? '_collection.html.twig' : '_preview.html.twig' %}
                                    {{ include([
                                        '@KachnitelAdmin/types/' ~ columnType ~ '/' ~ templateName,
                                        '@KachnitelAdmin/types/' ~ templateName
                                    ], {
                                        entity: entity,
                                        value: value,
                                        property: column,
                                        cell: true
                                    }, ignore_missing = true) }}
                                {% endif %}
                            {% else %}
                                {# Doctrine entity: use entity-based type detection for backwards compatibility #}
                                {% set templateName = admin_is_collection(entity, column) ? '_collection.html.twig' : '_preview.html.twig' %}
                                {{ include([
                                    '@KachnitelAdmin/types/' ~ this.entityClass|replace({'\\': '/'}) ~ '/' ~ column ~ '.html.twig',
                                    '@KachnitelAdmin/types/' ~ admin_get_property_type(entity, column)|replace({'\\': '/'}) ~ '/' ~ templateName,
                                    '@KachnitelAdmin/types/' ~ templateName
                                ], {
                                    entity: entity,
                                    value: value,
                                    property: column,
                                    cell: true
                                }, ignore_missing = true) }}
                            {% endif %}
                        </td>
                    {% endfor %}

                    {% if not isDoctrineEntity %}
                        {% include '@KachnitelAdmin/components/EntityList/_DataSourceRowActions.html.twig' with {
                            dataSourceId: this.dataSourceId,
                            dataSource: dataSource,
                            entityId: entityId
                        } only %}
                    {% else %}
                        {% include '@KachnitelAdmin/components/EntityList/_RowActions.html.twig' with {
                            entity: entity,
                            entityShortClass: this.entityShortClass
                        } only %}
                    {% endif %}
                </tr>
            {% else %}
                <tr>
                    <td colspan="{{ this.columns|length + (showBatchColumn ? 2 : 1) }}" class="text-center text-muted py-4">
                        No {{ dataSource.label }} found.
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Pagination Controls #}
    {% set paginationInfo = this.paginationInfo %}
    {% include '@KachnitelAdmin/components/EntityList/_Pagination.html.twig' with {
        paginationInfo: paginationInfo,
        page: this.page,
        allowedItemsPerPage: this.allowedItemsPerPage,
        itemsPerPage: this.itemsPerPage
    } only %}
</div>
