{#
 # LiveComponent template for reactive entity lists with per-column filters.
 #
 # Props:
 # @var string entityClass - Entity class name
 # @var string search - Global search query
 # @var string sortBy - Sort field
 # @var string sortDirection - ASC or DESC
 # @var array columnFilters - Per-column filter values
 #}

<div
    {% if this.isBatchActionsEnabled %}
        {{ attributes.defaults({ 'data-controller': 'batch-select' }) }}
    {% else %}
        {{ attributes }}
    {% endif %}
>
    {# Batch Actions Bar #}
    {% if this.isBatchActionsEnabled and this.canBatchDelete %}
        <div class="admin-batch-actions mb-3 d-flex gap-2 align-items-center">
            <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-batch-select-target="selectAllBtn"
                data-action="click->batch-select#selectAll"
            >
                Select All
            </button>
            <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="click->batch-select#deselectAll"
            >
                Deselect All
            </button>
            <div class="vr"></div>
            <button
                type="button"
                class="btn btn-sm btn-danger"
                data-action="click->batch-select#performBatchDelete"
            >
                Delete Selected (<span data-batch-select-target="count">{{ this.selectedIds|length }}</span>)
            </button>
            {# Hidden button that will actually trigger the LiveComponent action #}
            <button
                type="button"
                style="display: none;"
                data-batch-select-target="deleteButton"
                data-action="live#action"
                data-live-action-param="batchDelete"
            ></button>
        </div>
    {% endif %}

    {# Hidden input to store selectedIds - read by JS controller #}
    {% if this.isBatchActionsEnabled %}
        <input
            type="hidden"
            data-batch-select-target="selectedIds"
            value="{{ this.selectedIds|json_encode }}"
        >
    {% endif %}

    {# Global Search #}
    {% if block('search') is defined %}
        <div class="admin-global-search mb-3">
            {{ block('search') }}
        </div>
    {% else %}
        <div class="admin-global-search mb-3">
            <input
                type="text"
                class="form-control"
                placeholder="Global search across all columns..."
                data-model="search"
                value="{{ this.search }}"
            >
        </div>
    {% endif %}

    {# Entity List Table #}
    <table class="table table-hover">
        <thead>
            <tr>
                {% if this.isBatchActionsEnabled and this.canBatchDelete %}
                    <th style="width: 40px;">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            title="Select/Deselect All"
                            data-action="change->batch-select#selectAll"
                        >
                    </th>
                {% endif %}
                {% for column in this.columns %}
                    <th>
                        <button
                            type="button"
                            class="btn btn-link p-0 text-decoration-none"
                            data-action="live#action"
                            data-live-action-param="sort"
                            data-live-column-param="{{ column }}"
                        >
                            {{ column|humanize }}
                            {% if sortBy == column %}
                                <span class="sort-indicator">{{ sortDirection == constant('SORT_ASC', this) ? 'â–²' : 'â–¼' }}</span>
                            {% endif %}
                        </button>
                    </th>
                {% endfor %}
                <th>Actions</th>
            </tr>
            <tr class="filters">
                {% if this.isBatchActionsEnabled and this.canBatchDelete %}
                    <th></th>
                {% endif %}
                {% for column in this.columns %}
                    <th>
                        {% if this.filterMetadata[column] is defined %}
                            {#
                             Pass the initial value so it persists on re-renders.
                             #}
                            <twig:K:Admin:ColumnFilter
                                column="{{ column }}"
                                value="{{ this.columnFilters[column] ?? '' }}"
                                type="{{ this.filterMetadata[column].type|default('text') }}"
                            />
                        {% endif %}
                    </th>
                {% endfor %}
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for entity in this.entities %}
                {% set entityData = admin_get_entity_data(entity) %}
                {% set entityId = entityData.id ?? entityData[attribute(entity, 'id')] ?? loop.index %}
                <tr>
                    {% if this.isBatchActionsEnabled and this.canBatchDelete %}
                        <td>
                            <input
                                type="checkbox"
                                class="form-check-input"
                                value="{{ entityId }}"
                                {% if entityId in this.selectedIds %}checked{% endif %}
                                data-batch-select-target="checkbox"
                                data-action="change->batch-select#toggle"
                            >
                        </td>
                    {% endif %}
                    {% for column in this.columns %}
                        <td>
                            {% set value = entityData[column] ?? null %}
                            {% set templateName = admin_is_collection(entity, column) ? '_collection.html.twig' : '_preview.html.twig' %}
                            {{ include([
                                '@KachnitelAdmin/types/' ~ this.entityClass|replace({'\\': '/'}) ~ '/' ~ column ~ '.html.twig',
                                '@KachnitelAdmin/types/' ~ admin_get_property_type(entity, column)|replace({'\\': '/'}) ~ '/' ~ templateName,
                                '@KachnitelAdmin/types/' ~ templateName
                            ], {
                                entity: entity,
                                value: value,
                                property: column,
                                cell: true
                            }, ignore_missing = true) }}
                        </td>
                    {% endfor %}

                    <td class="actions">
                        {% if admin_action_accessible(this.entityShortClass, 'show') %}
                            <a href="{{ admin_object_path(entity, 'show') }}" class="btn btn-sm btn-outline-primary">
                                ðŸ‘€
                            </a>
                        {% endif %}

                        {% if admin_action_accessible(this.entityShortClass, 'edit') %}
                            <a href="{{ admin_object_path(entity, 'edit') }}" class="btn btn-sm btn-outline-primary">
                                ðŸ–Š
                            </a>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="{{ this.columns|length + (this.isBatchActionsEnabled and this.canBatchDelete ? 2 : 1) }}" class="text-center text-muted py-4">
                        No {{ this.entityShortClass }} found.
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Pagination Controls #}
    {% if this.totalPages > 0 %}
        <div class="pagination-wrapper d-flex justify-content-between align-items-center mt-3">
            {# Items per page selector #}
            <div class="items-per-page">
                <label for="items-per-page" class="form-label me-2">Items per page:</label>
                <select
                    id="items-per-page"
                    class="form-select form-select-sm d-inline-block w-auto"
                    data-model="itemsPerPage"
                >
                    {% for option in this.allowedItemsPerPage %}
                        <option value="{{ option }}" {% if option == this.itemsPerPage %}selected{% endif %}>
                            {{ option }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# Pagination info and controls #}
            <div class="pagination-info-controls d-flex align-items-center gap-3">
                {# Showing X-Y of Z #}
                <span class="text-muted">
                    {% if this.totalItems > 0 %}
                        Showing {{ this.startItem }}-{{ this.endItem }} of {{ this.totalItems }}
                    {% else %}
                        No items
                    {% endif %}
                </span>

                {# Page navigation #}
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        {# Previous button #}
                        <li class="page-item {% if this.page <= 1 %}disabled{% endif %}">
                            <button
                                class="page-link"
                                data-action="live#action"
                                data-live-action-param="previousPage"
                                {% if this.page <= 1 %}disabled{% endif %}
                            >
                                Previous
                            </button>
                        </li>

                        {# Page number display #}
                        <li class="page-item disabled">
                            <span class="page-link">
                                Page {{ this.page }} of {{ this.totalPages }}
                            </span>
                        </li>

                        {# Next button #}
                        <li class="page-item {% if this.page >= this.totalPages %}disabled{% endif %}">
                            <button
                                class="page-link"
                                data-action="live#action"
                                data-live-action-param="nextPage"
                                {% if this.page >= this.totalPages %}disabled{% endif %}
                            >
                                Next
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    {% endif %}
</div>
