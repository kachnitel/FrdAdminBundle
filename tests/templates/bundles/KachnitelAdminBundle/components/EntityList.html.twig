{# Override marker - DO NOT REMOVE #}
<!-- TEST_OVERRIDE:ENTITY_LIST -->
{#
 # LiveComponent template for reactive entity lists with per-column filters.
 #
 # Props:
 # @var string entityClass - Entity class name
 # @var string search - Global search query
 # @var string sortBy - Sort field
 # @var string sortDirection - ASC or DESC
 # @var array columnFilters - Per-column filter values
 #}

{% set batchEnabled = this.permissionService.isBatchActionsEnabled(this.entityClass) %}
{% set canBatchDelete = this.permissionService.canBatchDelete(this.entityClass, this.entityShortClass) %}
{% set showBatchColumn = batchEnabled and canBatchDelete %}

<div {{ attributes }} {% if batchEnabled %}data-controller="batch-select"{% endif %}>
    {# Batch Actions Bar #}
    {% if showBatchColumn %}
        {% include '@KachnitelAdmin/components/EntityList/_BatchActionsBar.html.twig' with {
            selectedCount: this.selectedIds|length
        } only %}
    {% endif %}

    {# Global Search #}
    {% if block('search') is defined %}
        <div class="admin-global-search mb-3">
            {{ block('search') }}
        </div>
    {% else %}
        <div class="admin-global-search mb-3">
            <input
                type="text"
                class="form-control"
                placeholder="Global search across all columns..."
                data-model="search"
                value="{{ this.search }}"
            >
        </div>
    {% endif %}

    {# Entity List Table #}
    <table class="table table-hover">
        <thead>
            <tr>
                {% if showBatchColumn %}
                    <th style="width: 40px;">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            title="Select/Deselect All"
                            data-batch-select-target="master"
                            data-action="change->batch-select#toggleAll"
                        >
                    </th>
                {% endif %}
                {% for column in this.columns %}
                    {% include '@KachnitelAdmin/components/EntityList/_SortableHeader.html.twig' with {
                        column: column,
                        sortBy: sortBy,
                        sortDirection: sortDirection,
                        component: this
                    } only %}
                {% endfor %}
                <th>Actions</th>
            </tr>
            <tr class="filters">
                {% if showBatchColumn %}
                    <th></th>
                {% endif %}
                {% for column in this.columns %}
                    <th>
                        {% if this.filterMetadata[column] is defined %}
                            {#
                             Pass the initial value so it persists on re-renders.
                             #}
                            <twig:K:Admin:ColumnFilter
                                column="{{ column }}"
                                value="{{ this.columnFilters[column] ?? '' }}"
                                type="{{ this.filterMetadata[column].type|default('text') }}"
                            />
                        {% endif %}
                    </th>
                {% endfor %}
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for entity in this.entities %}
                {% set entityData = admin_get_entity_data(entity) %}
                {% set entityId = entityData.id ?? entityData[attribute(entity, 'id')] ?? loop.index %}
                <tr>
                    {% if showBatchColumn %}
                        <td>
                            <input
                                type="checkbox"
                                class="form-check-input"
                                value="{{ entityId }}"
                                {% if entityId in this.selectedIds %}checked{% endif %}
                                data-model="selectedIds[]"
                                data-batch-select-target="checkbox"
                                data-action="click->batch-select#toggle"
                            >
                        </td>
                    {% endif %}
                    {% for property, value in entityData %}
                        <td>
                            {% set templateName = admin_is_collection(entity, property) ? '_collection.html.twig' : '_preview.html.twig' %}
                            {{ include([
                                '@KachnitelAdmin/types/' ~ this.entityClass|replace({'\\': '/'}) ~ '/' ~ property ~ '.html.twig',
                                '@KachnitelAdmin/types/' ~ admin_get_property_type(entity, property)|replace({'\\': '/'}) ~ '/' ~ templateName,
                                '@KachnitelAdmin/types/' ~ templateName
                            ], {
                                entity: entity,
                                value: value,
                                property: property,
                                cell: true
                            }, ignore_missing = true) }}
                        </td>
                    {% endfor %}

                    {% include '@KachnitelAdmin/components/EntityList/_RowActions.html.twig' with {
                        entity: entity,
                        entityShortClass: this.entityShortClass
                    } only %}
                </tr>
            {% else %}
                <tr>
                    <td colspan="{{ this.columns|length + (showBatchColumn ? 2 : 1) }}" class="text-center text-muted py-4">
                        No {{ this.entityShortClass }} found.
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Pagination Controls #}
    {% set paginationInfo = this.paginationInfo %}
    {% include '@KachnitelAdmin/components/EntityList/_Pagination.html.twig' with {
        paginationInfo: paginationInfo,
        page: this.page,
        allowedItemsPerPage: this.allowedItemsPerPage,
        itemsPerPage: this.itemsPerPage
    } only %}
</div>
